# AWS Deployment Guide

This guide will help you deploy the CyberTabletop game to AWS using a single EC2 instance with Docker Compose.

## Architecture Overview

- **Frontend**: Served via nginx in Docker container
- **Backend**: FastAPI + Socket.IO running in Docker container
- **Compute**: EC2 t3.micro or t3.small instance
- **Storage**: Local SQLite database (no additional cost)
- **Networking**: Single public IP with security group controls

## Cost Breakdown

### EC2 Instance Deployment
- **EC2 t3.micro** (1 vCPU, 1GB RAM): ~$7-8/month (1-year reserved) or ~$8-10/month (on-demand)
- **EC2 t3.small** (2 vCPU, 2GB RAM): ~$14-15/month (1-year reserved) or ~$16-18/month (on-demand)
- **EBS Storage** (20GB): ~$2/month
- **Data Transfer**: First 100GB free, then ~$0.09/GB
- **Total**: ~$9-20/month

This is a simple, cost-effective deployment that's easy to manage and allows you to leverage security groups for access control.

## Prerequisites

1. AWS Account
2. AWS CLI installed and configured (optional, for easier management)
3. SSH key pair for EC2 access

## Step-by-Step Deployment

### 1. Launch EC2 Instance

1. Go to AWS Console → EC2 → Launch Instance
2. **Name**: `cybertabletop-game`
3. **AMI**: Amazon Linux 2023 or Ubuntu 22.04 LTS
4. **Instance Type**: `t3.micro` (or `t3.small` for better performance)
5. **Key Pair**: Create or select an existing key pair
6. **Network Settings**: 
   - Create security group with rules:
     - **HTTP (80)**: Allow from `0.0.0.0/0`
     - **Backend API (8000)**: Allow from `0.0.0.0/0` (or restrict to your IP)
     - **SSH (22)**: Allow from your IP only
7. **Storage**: 20GB gp3 (default is fine)
8. **Launch Instance**

### 2. Connect to Instance

```bash
# Replace with your key file and instance IP
ssh -i your-key.pem ec2-user@YOUR_INSTANCE_IP
# For Ubuntu, use: ssh -i your-key.pem ubuntu@YOUR_INSTANCE_IP
```

### 3. Clone Repository

```bash
# Install git if needed
sudo yum install -y git  # Amazon Linux
# or
sudo apt-get update && sudo apt-get install -y git  # Ubuntu

# Clone the repository
cd /opt
sudo git clone https://github.com/zerop0wn/cybertabletopgame.git
sudo chown -R $USER:$USER cybertabletopgame
cd cybertabletopgame
```

### 4. Deploy Using CloudFormation (Recommended)

Use the provided CloudFormation template for automated setup:

```bash
# From your local machine with AWS CLI configured
cd aws
aws cloudformation create-stack \
  --stack-name pewpew-ec2 \
  --template-body file://cloudformation-ec2-simple.yaml \
  --parameters ParameterKey=KeyPairName,ParameterValue=your-key-pair-name \
  --capabilities CAPABILITY_NAMED_IAM

# Or use the PowerShell script
.\deploy-ec2.ps1
```

Alternatively, see `EC2-DEPLOYMENT-GUIDE.md` or `DEPLOY-ON-EC2.md` for manual setup instructions.

### 5. Configure Environment Variables

Edit the `.env` file created in `/opt/cybertabletop`:

```bash
cd /opt/cybertabletop
nano .env
```

Update these values:
- `JWT_SECRET`: Strong random secret (already generated)
- `GM_ADMIN_PASSWORD`: Change from default
- `VITE_PUBLIC_BACKEND_URL`: Update with your domain if using one, or keep EC2 IP

### 6. Restart Services

```bash
docker-compose -f docker-compose.prod.yml restart
```

### 7. Set Up Domain (Optional)

If you have a domain:

1. **Point DNS to EC2 IP**: Create an A record pointing to your EC2 instance's public IP
2. **Update VITE_PUBLIC_BACKEND_URL**: Change to `http://yourdomain.com:8000` or use a reverse proxy
3. **Set up SSL** (recommended): Use Let's Encrypt with nginx reverse proxy

## Quick Start

For the fastest deployment, see:
- `DEPLOY-ON-EC2.md` - Quick deploy commands
- `EC2-DEPLOYMENT-GUIDE.md` - Detailed manual setup
- `MANUAL-EC2-SETUP.md` - Step-by-step manual configuration

## Security Considerations

1. **Change default passwords**: Update `GM_ADMIN_PASSWORD` in `.env`
2. **Use strong JWT secret**: Already generated by deploy script
3. **Restrict backend port**: Only allow port 8000 from frontend or use reverse proxy
4. **Set up SSL/TLS**: Use Let's Encrypt with nginx for HTTPS
5. **Regular updates**: Keep Docker images and system updated

## Monitoring and Maintenance

### View Logs
```bash
cd ~/cybertabletopgame
sudo docker-compose -f docker-compose.prod.yml logs -f
```

### Restart Services
```bash
cd ~/cybertabletopgame
sudo docker-compose -f docker-compose.prod.yml restart
```

### Update Application
```bash
cd ~/cybertabletopgame  # or wherever you cloned the repo
git pull
sudo docker-compose -f docker-compose.prod.yml build
sudo docker-compose -f docker-compose.prod.yml up -d
```

### Backup Data
```bash
# Backup SQLite database
cd ~/cybertabletopgame
cp backend/data/game.db backend/data/game.db.backup.$(date +%Y%m%d)
```

## Performance Tuning

For 20+ concurrent players:

1. **Use t3.small** instead of t3.micro for better performance
2. **Increase uvicorn workers** in `backend/Dockerfile.prod`:
   ```dockerfile
   CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "4"]
   ```
3. **Monitor CloudWatch** metrics for CPU and memory usage
4. **Adjust Docker resources** if needed (memory limits, CPU shares)

## Troubleshooting

### Services won't start
```bash
# Check logs
cd ~/cybertabletopgame
sudo docker-compose -f docker-compose.prod.yml logs

# Check if ports are in use
sudo netstat -tulpn | grep -E ':(80|8000)'
# or
sudo ss -tulpn | grep -E ':(80|8000)'
```

### Can't access from browser
- Check security group rules allow HTTP (80) and backend (8000)
- Verify instance has public IP
- Check firewall rules on instance

### WebSocket connections fail
- Ensure port 8000 is open in security group
- Check CORS settings in backend
- Verify `VITE_PUBLIC_BACKEND_URL` matches actual backend URL

## Cost Optimization Tips

1. **Use Reserved Instances**: Save up to 40% with 1-year reserved instances
2. **Stop when not in use**: Stop EC2 instance when not playing (only pay for storage)
3. **Monitor data transfer**: First 100GB/month is free, then $0.09/GB
4. **Use t3.micro** for development/testing, upgrade to t3.small only when needed

## Support

For issues or questions, check the main README.md or open an issue on GitHub.

